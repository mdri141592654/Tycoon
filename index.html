<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Gebrauchtwagenhändler Tycoon</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { font-weight: bold; margin-bottom: 20px; }
        .dropdown { margin-bottom: 20px; }
        .car { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
        .bar { background: #ddd; width: 100%; height: 10px; margin: 5px 0; position: relative; }
        .bar-fill { background: green; height: 100%; }
        .progress { height: 10px; background: #eee; margin-top: 5px; }
        .modal {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -30%);
            background: white;
            border: 2px solid #444;
            padding: 20px;
            z-index: 1000;
        }
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>

<div class="status" id="status">Kontostand: 5000€ / Fahrzeuge im Bestand: 0</div>

<details class="dropdown">
    <summary>Fahrzeuge zum Kauf</summary>
    <div id="market"></div>
</details>

<details class="dropdown">
    <summary>Fahrzeuge im Bestand</summary>
    <div id="inventory"></div>
</details>

<details class="dropdown">
    <summary>Inserierte Fahrzeuge</summary>
    <div id="listed"></div>
</details>

<div id="modal-container"></div>

<script>
    let balance = 5000;
    let inventory = [];
    let listed = [];
    let marketCars = [];

    const manufacturers = ["AutoLux", "RoadMax", "VelociCar", "SunDrive", "PrimeAuto"];
    const models = ["Turbo", "Speedster", "Comet", "Falcon", "EcoRide"];

    function updateStatus() {
        document.getElementById("status").innerText = `Kontostand: ${balance}€ / Fahrzeuge im Bestand: ${inventory.length}`;
    }

    function getRandomCar() {
        const manufacturer = manufacturers[Math.floor(Math.random() * manufacturers.length)];
        const model = models[Math.floor(Math.random() * models.length)];
        const optik = Math.floor(Math.random() * 70) + 10;
        const technik = Math.floor(Math.random() * 70) + 10;
        const price = Math.floor((optik + technik) * 10 + Math.random() * 500);
        const repCost = Math.floor((100 - technik) * 2 + (100 - optik));
        const id = Math.random().toString(36).substring(2, 9);
        const ttl = Date.now() + (30000 + Math.random() * 240000);
        return { id, manufacturer, model, optik, technik, price, repCost, ttl };
    }

    function renderMarket() {
        const now = Date.now();
        marketCars = marketCars.filter(car => car.ttl > now);
        const container = document.getElementById("market");
        container.innerHTML = "";
        marketCars.forEach(car => {
            const div = document.createElement("div");
            div.className = "car";
            const timeLeft = Math.max(0, Math.floor((car.ttl - now) / 1000));
            div.innerHTML = `
                <strong>${car.manufacturer} ${car.model}</strong><br>
                Optik: <div class="bar"><div class="bar-fill" style="width:${car.optik}%; background:orange"></div></div>
                Technik: <div class="bar"><div class="bar-fill" style="width:${car.technik}%; background:blue"></div></div>
                Geschätzte Reparaturkosten: ${car.repCost}€<br>
                Kaufpreis: ${car.price}€<br>
                Verfügbar für: ${timeLeft}s<br>
                <button onclick="buyCar('${car.id}')">Kaufen</button>
            `;
            container.appendChild(div);
        });
    }

    function buyCar(id) {
        const car = marketCars.find(c => c.id === id);
        if (!car) return;
        const price = parseInt(car.price);
        if (balance < price) return alert("Nicht genug Geld!");
        balance -= price;
        updateStatus();
        marketCars = marketCars.filter(c => c.id !== id);
        renderMarket();
        setTimeout(() => {
            inventory.push({ ...car, repairTotal: 0, salePrice: null });
            updateStatus();
            renderInventory();
        }, 3000);
    }

    let busy = false;

    function renderInventory() {
        const container = document.getElementById("inventory");
        container.innerHTML = "";
        inventory.forEach((car, index) => {
            const div = document.createElement("div");
            div.className = "car";
            div.innerHTML = `
                <strong>${car.manufacturer} ${car.model}</strong><br>
                Optik: <div class="bar"><div class="bar-fill" style="width:${car.optik}%; background:orange"></div></div>
                Technik: <div class="bar"><div class="bar-fill" style="width:${car.technik}%; background:blue"></div></div>
                Gesamt-Kosten bisher: ${car.price + car.repairTotal}€<br>
                <button onclick="repair(${index})" ${busy ? 'disabled' : ''}>Reparieren (${(100 - car.technik) * 2}€)</button>
                <button onclick="polish(${index})" ${busy ? 'disabled' : ''}>Optisch aufwerten (${Math.floor((100 - car.optik) / 2)}€)</button>
                <button onclick="prepareSale(${index})" ${busy ? 'disabled' : ''}>Inserieren</button>
                <div class="progress" id="progress-${index}"></div>
            `;
            container.appendChild(div);
        });
    }

    function animateProgress(id, duration, callback) {
        const bar = document.getElementById(id);
        let start = Date.now();
        const interval = setInterval(() => {
            const percent = Math.min(100, ((Date.now() - start) / duration) * 100);
            bar.innerHTML = `<div class="bar"><div class="bar-fill" style="width:${percent}%; background:gray"></div></div>`;
            if (percent >= 100) {
                clearInterval(interval);
                callback();
            }
        }, 100);
    }

    function repair(index) {
        if (busy) return;
        const car = inventory[index];
        const cost = (100 - car.technik) * 2;
        if (car.technik >= 100 || balance < cost) return;
        busy = true;
        balance -= cost;
        updateStatus();
        animateProgress(`progress-${index}`, 3000, () => {
            car.technik = 100;
            car.repairTotal += cost;
            busy = false;
            renderInventory();
        });
    }

    function polish(index) {
        if (busy) return;
        const car = inventory[index];
        const cost = Math.floor((100 - car.optik) / 2);
        if (car.optik >= 100 || balance < cost) return;
        busy = true;
        balance -= cost;
        updateStatus();
        animateProgress(`progress-${index}`, 3000, () => {
            car.optik = 100;
            car.repairTotal += cost;
            busy = false;
            renderInventory();
        });
    }

    function prepareSale(index) {
        if (busy) return;
        const car = inventory[index];
        const totalCost = car.price + car.repairTotal;
        const minPrice = totalCost;
        const maxPrice = totalCost + 2000;
        const defaultPrice = totalCost + 500;

        const modalContainer = document.getElementById("modal-container");
        modalContainer.innerHTML = `
            <div class="overlay" onclick="closeModal()"></div>
            <div class="modal">
                <p><strong>Inseratspreis festlegen</strong></p>
                <p>Gesamtkosten bisher: ${totalCost}€</p>
                <input type="range" id="priceSlider" min="${minPrice}" max="${maxPrice}" value="${defaultPrice}" step="10" style="width:100%;">
                <p>Preis: <span id="sliderValue">${defaultPrice}</span>€</p>
                <button onclick="confirmSale(${index})">Inserieren</button>
                <button onclick="closeModal()">Abbrechen</button>
            </div>
        `;

        document.getElementById("priceSlider").oninput = function () {
            document.getElementById("sliderValue").innerText = this.value;
        };
    }

    function confirmSale(index) {
        const price = parseInt(document.getElementById("priceSlider").value);
        const car = inventory[index];
        car.salePrice = price;
        car.saleStart = Date.now();
        listed.push(car);
        inventory.splice(index, 1);
        closeModal();
        renderInventory();
        renderListed();
    }

    function closeModal() {
        document.getElementById("modal-container").innerHTML = "";
    }

    function renderListed() {
        const container = document.getElementById("listed");
        container.innerHTML = "";
        const now = Date.now();

        listed.forEach((car, index) => {
            const div = document.createElement("div");
            div.className = "car";
            const totalCost = car.price + car.repairTotal;
            const waitTime = Math.max(30000, Math.min(300000, (100 - ((car.optik + car.technik) / 2)) * 1000 + (car.salePrice - totalCost) * 5));
            const elapsed = now - car.saleStart;
            const percent = Math.min(100, (elapsed / waitTime) * 100);
            div.innerHTML = `
                <strong>${car.manufacturer} ${car.model}</strong><br>
                Verkaufspreis: ${car.salePrice}€<br>
                <div class="bar"><div class="bar-fill" style="width:${percent}%; background:green"></div></div>
            `;
            container.appendChild(div);

            if (percent >= 100) {
                const successChance = 1 - Math.min(0.5, (car.salePrice - totalCost) / totalCost);
                if (Math.random() < successChance) {
                    balance += car.salePrice;
                    listed.splice(index, 1);
                    updateStatus();
                    renderListed();
                } else {
                    setTimeout(() => {
                        inventory.push(car);
                        listed.splice(index, 1);
                        updateStatus();
                        renderInventory();
                        renderListed();
                    }, 3000);
                }
            }
        });
    }

    function updateLoop() {
        renderMarket();
        renderListed();
    }

    function generateMarketCars() {
        while (marketCars.length < 5) {
            marketCars.push(getRandomCar());
        }
    }

    setInterval(() => {
        generateMarketCars();
        updateLoop();
    }, 1000);

    updateStatus();
</script>

</body>
</html>
